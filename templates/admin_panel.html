{% extends "layout.html" %}

{% block title %}Admin Panel{% endblock %}

{% block head_styles %}
<style>
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; flex-wrap: wrap; gap: 10px; }
    .grid-layout { display: grid; grid-template-columns: 1fr; gap: 40px; }
    @media (min-width: 992px) { .grid-layout { grid-template-columns: 1fr 2fr; } }
    .session-card { display: flex; gap: 20px; align-items: flex-start; border-left: 4px solid; margin-bottom: 15px; }
    .poster-thumb { width: 80px; height: 120px; object-fit: cover; border-radius: 4px; flex-shrink: 0; background-color: #333; }
    .session-info p { margin: 5px 0; font-size: 0.9em; }
    .status-scheduled { border-color: var(--text-secondary); }
    .status-vestibule { border-color: var(--warning); }
    .status-active { border-color: var(--success); }
    .status-finished { border-color: var(--danger); opacity: 0.6; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Panel de Control</h1>
        <a href="{{ url_for('logout') }}" class="btn btn-secondary">Cerrar Sesión</a>
    </div>
    <div class="grid-layout">
        <aside>
            <!-- Formulario de Subida -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>Subir Película</h2>
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <div class="form-group"><label>Archivo de Vídeo:</label><input type="file" name="movie_file" accept="video/*" required></div>
                    <div class="form-group"><label>Archivo de Póster:</label><input type="file" name="poster_file" accept="image/*" required></div>
                    <button type="submit" class="btn" style="width:100%;">Subir Paquete</button>
                </form>
            </div>
            <!-- Formulario de Programación -->
            <div class="card">
                <h2>Programar Sesión</h2>
                <form action="{{ url_for('schedule_session') }}" method="post">
                    <div class="form-group">
                        <label for="movie-select">Película:</label>
                        <select name="movie_title" id="movie-select" required>
                            {% for title, file in movies.items() %}
                                <option value="{{ title }}">{{ title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="time-select">Fecha y Hora:</label>
                        <input type="datetime-local" name="scheduled_time" required>
                    </div>

                    <div class="form-group">
                        <label for="password-input">Contraseña (opcional):</label>
                        <input type="text" name="session_password" id="password-input" placeholder="Dejar en blanco para no usar contraseña">
                    </div>

                    <button type="submit" class="btn" style="width:100%;" {% if not movies %}disabled{% endif %}>Programar</button>
                </form>
            </div>
        </aside>
        <main>
            <h2>Sesiones Programadas y Activas</h2>
            <div id="session-list">
                {% for s in sessions %}
                <div class="card session-card status-{{ s.current_status_in_memory }}">
                    <img class="poster-thumb" src="{{ url_for('static', filename='posters/' + s.poster_file) if s.poster_file else '' }}" alt="Póster">
                    <div class="session-info">
                        <h3>{{ s.movie_title }}</h3>
                        <p><strong>Hora:</strong> {{ s.scheduled_time }}</p>
                        <!-- Esto ahora es seguro y nunca fallará -->
                        <p><strong>Estado:</strong> <span style="text-transform: capitalize;">{{ s.current_status_in_memory.replace('_', ' ') }}</span></p>
                        <p>
                            <strong>Usuarios:</strong>
                            <span>Vestíbulo: {{ s.user_count_vestibule }}</span> |
                            <span>Sala: {{ s.user_count_watch_room }}</span>
                        </p>
                        <div class="actions">
                            {% if s.status != 'finished' %}
                                <a href="{{ url_for('vestibulo', session_id=s.id) }}" target="_blank" class="btn btn-secondary btn-small">Vestíbulo</a>
                                <a href="{{ url_for('watch_room', session_id=s.id) }}" target="_blank" class="btn btn-small">Cabina</a>
                                <button class="btn btn-info btn-small manage-moderation-btn" data-session-id="{{ s.id }}">Moderar</button>
                            {% endif %}
                            <form action="{{ url_for('delete_session', session_id=s.id) }}" method="post" onsubmit="return confirm('¿Borrar esta sesión?');" style="margin:0;">
                                <button type="submit" class="btn btn-danger btn-small">Borrar</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <p>No hay sesiones programadas.</p>
                {% endfor %}
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    // Recargar el panel de admin si hay cambios en las sesiones
    const socket = io(); // Ya está definido globalmente si chat_logic.js se carga antes o se define aquí

    socket.on('admin_panel_update', () => {
        // Podríamos hacer una recarga más inteligente, pero por ahora reload es simple.
        location.reload();
    });

    function setupAdminModerationTools() {
        document.querySelectorAll('.manage-moderation-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sessionId = this.dataset.sessionId;
                openModerationModal(sessionId);
            });
        });
    }

    function openModerationModal(sessionId) {
        // Crear o obtener el modal
        let modal = document.getElementById('moderation-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'moderation-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7); display: flex;
                justify-content: center; align-items: center; z-index: 1050;
            `;
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: var(--bg-dark); color: var(--text-primary); padding: 30px;
                border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
            `;
            modalContent.innerHTML = `
                <h2 style="margin-top:0;">Moderar Sesión <span id="modal-session-id"></span></h2>
                <div style="display:flex; gap: 20px;">
                    <div style="flex:1;">
                        <h4>Usuarios Silenciados</h4>
                        <ul id="muted-users-list" style="list-style:none; padding:0;"></ul>
                    </div>
                    <div style="flex:1;">
                        <h4>Usuarios Baneados</h4>
                        <ul id="banned-users-list" style="list-style:none; padding:0;"></ul>
                    </div>
                </div>
                <button id="close-modal-btn" class="btn btn-secondary" style="margin-top:20px;">Cerrar</button>
            `;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            document.getElementById('close-modal-btn').onclick = () => modal.style.display = 'none';
            modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none';};
        }

        document.getElementById('modal-session-id').textContent = sessionId;
        const mutedList = document.getElementById('muted-users-list');
        const bannedList = document.getElementById('banned-users-list');
        mutedList.innerHTML = '<li>Cargando...</li>';
        bannedList.innerHTML = '<li>Cargando...</li>';
        modal.style.display = 'flex';

        // Solicitar las listas al backend para esta sesión específica
        // Necesitamos un evento 'admin_action' específico para el panel,
        // o que el backend sepa que este socket es de un admin global.
        // Por ahora, asumiremos que el 'admin_action' del backend puede identificar la sesión.
        // El backend debe responder con un evento como 'moderation_lists_update'
        socket.emit('admin_action', { session_id: sessionId, action: 'get_moderation_lists' });
    }

    socket.on('moderation_lists_update', (data) => { // data = { muted: [], banned: [] }
        const mutedList = document.getElementById('muted-users-list');
        const bannedList = document.getElementById('banned-users-list');
        const currentSessionId = document.getElementById('modal-session-id').textContent;

        if (!mutedList || !bannedList) return; // Modal no está abierto o elementos no encontrados

        mutedList.innerHTML = '';
        if (data.muted && data.muted.length > 0) {
            data.muted.forEach(username => {
                const li = document.createElement('li');
                li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 5px 0; border-bottom: 1px solid var(--bg-light);';
                li.innerHTML = `<span>${username}</span> <button class="btn btn-small btn-warning unmuted-btn" data-username="${username}">Quitar Silencio</button>`;
                mutedList.appendChild(li);
            });
            document.querySelectorAll('.unmuted-btn').forEach(btn => {
                btn.onclick = function() {
                    socket.emit('admin_action', { session_id: currentSessionId, action: 'unmute_user', username: this.dataset.username, room_type: 'watch_room' }); // Asumir watch_room
                    // Podríamos esperar confirmación o actualizar optimisticamente
                    this.closest('li').remove();
                };
            });
        } else {
            mutedList.innerHTML = '<li>No hay usuarios silenciados.</li>';
        }

        bannedList.innerHTML = '';
        if (data.banned && data.banned.length > 0) {
            data.banned.forEach(username => {
                const li = document.createElement('li');
                li.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 5px 0; border-bottom: 1px solid var(--bg-light);';
                li.innerHTML = `<span>${username}</span> <button class="btn btn-small btn-danger unban-btn" data-username="${username}">Desbanear</button>`;
                bannedList.appendChild(li);
            });
            document.querySelectorAll('.unban-btn').forEach(btn => {
                btn.onclick = function() {
                    if (confirm(`¿Desbanear a ${this.dataset.username} de esta sesión?`)) {
                        socket.emit('admin_action', { session_id: currentSessionId, action: 'unban_user', username: this.dataset.username, room_type: 'watch_room' }); // Asumir watch_room
                        this.closest('li').remove();
                    }
                };
            });
        } else {
            bannedList.innerHTML = '<li>No hay usuarios baneados.</li>';
        }
    });

    document.addEventListener('DOMContentLoaded', setupAdminModerationTools);

</script>
{% endblock %}